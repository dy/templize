let e,t,r=r=>(e=0,t=r,r=l(),t[e]?s():r||""),s=(r="Bad syntax",s=t[e],a=t.slice(0,e).split("\n"),l=a.pop())=>{throw SyntaxError(`${r} \`${s}\` at ${a.length}:${l.length}`)},a=(r=1,s=e,a)=>{if("number"==typeof r)e+=r;else for(;a=r(t.charCodeAt(e));)e+=a;return t.slice(s,e)},l=(t=0,a,l,n,i,c)=>{for(;(l=r.space())&&(i=((c=o[l])&&c(n,t))??(!n&&r.id()));)n=i;return a&&(l==a?e++:s()),n},n=e=>e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||36==e||95==e||e>=192&&215!=e&&247!=e;r.space=r=>{for(;(r=t.charCodeAt(e))<=32;)e++;return r},r.id=e=>a(n);let o=[],i=(r,s=32,a,l=r.charCodeAt(0),i=r.length,c=o[l],p=r.toUpperCase()!==r)=>o[l]=(l,o,u=e)=>o<s&&(i<2||t.substr(e,i)==r)&&(!p||!n(t.charCodeAt(e+i)))&&(e+=i,a(l,o))||(e=u,c?.(l,o));const c=e=>Array.isArray(e)?p[e[0]](...e.slice(1)):t=>t?.[e],p={},u=(e,t,r=p[e])=>p[e]=(...e)=>t(...e)||r&&r(...e),h=(e,t,r)=>r[0]||r[1]?(t?i(e,t,r[0]):o[e.charCodeAt(0)||1]=r[0],u(e,r[1])):r.length?r.length>1?(((e,t,r)=>{i(e,t,((s,a)=>s&&(a=l(t-!!r))&&[e,s,a]))})(e,Math.abs(t),t<0),u(e,((e,t)=>t&&(e=c(e),t=c(t),e.length||t.length?s=>r(e(s),t(s)):(e=r(e(),t()),()=>e))))):(((e,t,r)=>{i(e,t,(r=>!r&&(r=l(t-1))&&[e,r]))})(e,t),u(e,((e,t)=>!t&&((e=c(e)).length?t=>r(e(t)):(e=r(e()),()=>e))))):(((e,t,r)=>{i(e,t,((r,s)=>r&&((s=l(t))||void 0)&&(r[0]===e&&r[2]?(r.push(s||null),r):[e,r,s])))})(e,t),u(e,((...e)=>(e=e.map(c),t=>r(...e.map((e=>e(t)))))))),f=e=>e?s():["",(e=+a((e=>46===e||e>=48&&e<=57||(69===e||101===e?2:0))))!=e?s():e],d=(e,t,r,s)=>[e,t,[r=>r?["++"===e?"-":"+",[e,r],["",1]]:[e,l(t-1)],s=(e,t)=>"("===e[0]?s(e[1]):"."===e[0]?(t=e[2],e=c(e[1]),s=>r(e(s),t)):"["===e[0]?([,e,t]=e,e=c(e),t=c(t),s=>r(e(s),t(s))):t=>r(t,e)]],b=["",,[,e=>()=>e],'"',,[e=>e?s():["",(a()+a((e=>e-34?1:0))+(a()||s("Bad string"))).slice(1,-1)]],".",,[e=>!e&&f()],...Array(10).fill(0).flatMap(((e,t)=>[""+t,0,[f]])),",",1,(...e)=>e[e.length-1],"||",4,(...e)=>{let t,r=0;for(;!t&&r<e.length;)t=e[r++];return t},"&&",5,(...e)=>{let t=0,r=!0;for(;r&&t<e.length;)r=e[t++];return r},"+",12,(e,t)=>e+t,"-",12,(e,t)=>e-t,"*",13,(e,t)=>e*t,"/",13,(e,t)=>e/t,"%",13,(e,t)=>e%t,"|",6,(e,t)=>e|t,"&",8,(e,t)=>e&t,"^",7,(e,t)=>e^t,"==",9,(e,t)=>e==t,"!=",9,(e,t)=>e!=t,">",10,(e,t)=>e>t,">=",10,(e,t)=>e>=t,"<",10,(e,t)=>e<t,"<=",10,(e,t)=>e<=t,">>",11,(e,t)=>e>>t,">>>",11,(e,t)=>e>>>t,"<<",11,(e,t)=>e<<t,"+",15,e=>+e,"-",15,e=>-e,"!",15,e=>!e,...d("++",15,((e,t)=>++e[t])),...d("--",15,((e,t)=>--e[t])),"[",18,[e=>e&&["[",e,l(0,93)||s()],(e,t)=>t&&(e=c(e),t=c(t),r=>e(r)[t(r)])],".",18,[(e,t)=>e&&(t=l(18))&&[".",e,t],(e,t)=>(e=c(e),t=t[0]?t:t[1],r=>e(r)[t])],"(",18,[e=>!e&&["(",l(0,41)||s()],c],"(",18,[e=>e&&["(",e,l(0,41)||""],(e,t,r,s)=>null!=t&&(s=""==t?()=>[]:","===t[0]?(t=t.slice(1).map(c),e=>t.map((t=>t(e)))):(t=c(t),e=>[t(e)]),"."===e[0]?(r=e[2],e=c(e[1]),t=>e(t)[r](...s(t))):"["===e[0]?(r=c(e[2]),e=c(e[1]),t=>e(t)[r(t)](...s(t))):(e=c(e),t=>e(t)(...s(t))))]];for(;b[2];)h(...b.splice(0,3));Symbol.observable||=Symbol("observable");const m=e=>e&&!!(e[Symbol.observable]||e[Symbol.asyncIterator]||e.call&&e.set||e.subscribe||e.then),g=new FinalizationRegistry((e=>e.call?.()));var v=(e,t,r,s,a,l)=>{return e&&(n=(e[Symbol.observable]?.()||e).subscribe?.(t,r,s),l=n&&(()=>n.unsubscribe?.())||e.set&&e.call?.(a,t)||(e.then?.((e=>(!a&&t(e),s?.())),r)||(async l=>{try{for await(l of e){if(a)return;t(l)}s?.()}catch(e){r?.(e)}})())&&(e=>a=1),g.register(e,l),l);var n};const y=(e,t,r,s)=>(e[t="on"===t.slice(0,2)?t.toLowerCase():t]!==r&&(!(t in e.constructor.prototype)||!(s=Object.getOwnPropertyDescriptor(e.constructor.prototype,t))||s.set)&&(e[t]=r),!1===r||null==r?e.removeAttribute(t):"function"!=typeof r&&e.setAttribute(t,!0===r?"":"number"==typeof r||"string"==typeof r?r:"class"===t&&Array.isArray(r)?r.filter(Boolean).join(" "):"style"===t&&r.constructor===Object?(t=r,r=Object.values(r),Object.keys(t).map(((e,t)=>`${e}: ${r[t]};`)).join(" ")):"")),x=(e,t,r,s=null)=>{let a,l,n,o=0,i=r.length,c=t.length,{remove:p,same:u,insert:h,replace:f}=x;for(;o<i&&o<c&&u(t[o],r[o]);)o++;for(;o<i&&o<c&&u(r[i-1],t[c-1]);)s=r[(--c,--i)];if(o==c)for(;o<i;)h(s,r[o++],e);else{for(a=t[o];o<i;)n=r[o++],l=a?a.nextSibling:s,u(a,n)?a=l:o<i&&u(r[o],l)?(f(a,n,e),a=l):h(a,n,e);for(;!u(a,s);)l=a.nextSibling,p(a,e),a=l}return r};x.same=(e,t)=>e==t,x.replace=(e,t,r)=>r.replaceChild(t,e),x.insert=(e,t,r)=>r.insertBefore(t,e),x.remove=(e,t)=>t.removeChild(e);const A={processCallback(e,t,r){if(r)for(const e of t)if(e.expression in r){const t=r[e.expression];"boolean"==typeof t&&e instanceof N&&"boolean"==typeof e.element[e.attributeName]?e.booleanValue=t:e.value=t}}};class C extends DocumentFragment{#e;#t;constructor(e,t,r=A){super(),this.appendChild(e.content.cloneNode(!0)),this.#e=k(this),this.#t=r,t||={},r.createCallback?.(this,this.#e,t),r.processCallback(this,this.#e,t)}update(e){this.#t.processCallback(this,this.#e,e)}}class w{constructor(e,t){this.setter=e,this.expression=t}toString(){return this.value}}class N extends w{#r="";get attributeName(){return this.setter.attr.name}get attributeNamespace(){return this.setter.attr.namespaceURI}get element(){return this.setter.element}get value(){return this.#r}set value(e){if(this.#r===e)return;this.#r=e;const{attr:t,element:r,parts:s}=this.setter;1===s.length?null==e?r.removeAttributeNS(t.namespaceURI,t.name):r.setAttributeNS(t.namespaceURI,t.name,e):r.setAttributeNS(t.namespaceURI,t.name,s.join(""))}get booleanValue(){this.setter.element.hasAttribute(this.setter.attr.name)}set booleanValue(e){if(1!==this.setter.parts.length)throw new DOMException("Value is not fully templatized");this.value=e?"":null}}class S extends w{#s=[new Text];get replacementNodes(){return this.#s}get parentNode(){return this.setter.parentNode}get nextSibling(){return this.#s[this.#s.length-1].nextSibling}get previousSibling(){return this.#s[0].previousSibling}get value(){return this.#s.map((e=>e.textContent)).join("")}set value(e){this.replace(e)}replace(...e){(e=e.flat().flatMap((e=>null==e?[new Text]:e.forEach?[...e]:11===e.nodeType?[...e.childNodes]:e.nodeType?[e]:[new Text(e)]))).length||e.push(new Text),this.#s=x(this.#s[0].parentNode,this.#s,e,this.nextSibling)}replaceHTML(e){const t=this.parentNode.cloneNode();t.innerHTML=e,this.replace(t.childNodes)}}class T extends S{directive;constructor(e,t){let r=t.getAttribute("directive")||t.getAttribute("type"),s=t.getAttribute("expression")||t.getAttribute(r)||"";s.startsWith("{{")&&(s=s.trim().slice(2,-2).trim()),super(e,s),this.template=t,this.directive=r}}const k=(e,t=[])=>{let r,s,a,l,n;for(r of e.attributes||[])if(r.value.includes("{{")){for([l,n]of(a={element:e,attr:r,parts:[]},j(r.value)))l?(n=new N(a,n),a.parts.push(n),t.push(n)):a.parts.push(n);r.value=a.parts.join("")}for(s of e.childNodes)if(1!==s.nodeType||s instanceof HTMLTemplateElement){if(1===s.nodeType||s.data.includes("{{")){const r={parentNode:e,parts:[]};if(s.data)for([l,n]of j(s.data))l?(n=new S(r,n),r.parts.push(n),t.push(n)):r.parts.push(new Text(n));else n=new T(r,s),r.parts.push(n),t.push(n);s.replaceWith(...r.parts.flatMap((e=>e.replacementNodes||[e])))}}else k(s,t);return t},j=e=>{let t,r="",s=0,a=M[e],l=0;if(a)return a;for(a=[];t=e[l];l++)"{"===t&&"{"===e[l+1]&&"\\"!==e[l-1]&&e[l+2]&&1==++s?(r&&a.push([0,r]),r="",l++):"}"!==t||"}"!==e[l+1]||"\\"===e[l-1]||--s?r+=t||"":(a.push([1,r.trim()]),r="",l++);return r&&a.push([0,(s>0?"{{":"")+r]),M[e]=a},M={};var O=(e,t,r=U)=>{for(let t in B)B[t].prepare(e);let s,a=k(e),l=t=>r.processCallback(e,a,t);return t||={},r.createCallback?.(e,a,t),r.processCallback(e,a,t),t[Symbol.iterator]=function*(){yield s,yield l,yield a},s=new Proxy(t,{set:(e,r,s)=>(t[r]=s,l(t),1),deleteProperty:(e,r)=>(delete t[r],l(),1)})};let P={n:"\n",r:"\r",t:"\t",b:"\b",f:"\f",v:"\v"},$=r=>(l,n,o="")=>{for(l&&s("Unexpected string"),a();(n=t.charCodeAt(e))-r;)92===n?(a(),n=a(),o+=P[n]||n):o+=a();return a(),["",o]},I=(e,...t)=>t.flatMap((e=>Array.isArray(e)?I(...e):e?[e]:[]));h('"',null,[$(34)]),h("'",null,[$(39)]),h("?",3,[(e,t,r)=>e&&(t=l(2,58))&&["?",e,t,l(3)],(e,t,r)=>(e=c(e),t=c(t),r=c(r),s=>e(s)?t(s):r(s))]),h("??",6,((e,t)=>e??t)),h("?.",18,[e=>e&&["?.",e],e=>(e=c(e),t=>e(t)||(()=>{}))]),h("?.",18,[(e,t)=>e&&!(t=l(18))?.map&&["?.",e,t],(e,t)=>t&&(e=c(e),r=>e(r)?.[t])]),h("null",20,[e=>e?s():["",null]]),h("true",20,[e=>e?s():["",!0]]),h("false",20,[e=>e?s():["",!1]]),h("undefined",20,[e=>e?s():["",void 0]]),h("|",6,((e,t)=>t(e))),h("in",10,[(e,t)=>["in",e,l(10)],(e,t)=>r=>[e,r[t]]]);const R=new WeakMap,U={createCallback(e,t,s){if(R.get(e))return;let a,l,n={},o={},i=(t,r,s)=>{for(let o in t)m(a=t[o])?E.register(a,v(a,(t=>(r[o]=t,l&&this.processCallback(e,n[s||o]))))):a?.constructor===Object?i(a,r[o]={},s||o):r[o]=a};for(const a of t){const t=r(a.expression);I(null,t).map((e=>(n[e]||=[]).push(a))),a.eval=c(t),B[a.directive]?.create(e,a,s)}i(s,o),R.set(e,[o]),l=!0},processCallback(e,t,r){let s,a,[l]=R.get(e);for(s of(W(l,r),t))(a=s.eval(l))!==s.value&&(s.replace?s.replace(a):1===s.setter.parts.length?y(s.element,s.attributeName,s.value=a):s.value=a)}},E=new FinalizationRegistry((e=>e?.call?.())),W=(e,t)=>{for(let r in t)r in e&&(t[r]?.constructor==Object?W(e[r],t[r]):!m(t[r])&&(e[r]=t[r]))},B={},L=(e,t)=>B[e]={prepare(t,r=t.querySelectorAll(`[\\:${e}]`),s,a,l){for(t of r)t.replaceWith(s=new Text),(a=document.createElement("template")).content.appendChild(t),a.setAttribute("directive",e),l=t.getAttribute(":"+e),a.setAttribute("expression",l.slice(l.indexOf("{{")+2,l.lastIndexOf("}}"))),t.removeAttribute(":"+e),s.replaceWith(a)},create:t};L("if",((e,t)=>{(t.addCase=(e,r=e.eval)=>e.eval=s=>t.match?"":r(s)?(t.match=e,new C(e.template,s,U)):"")(e.ifPart=t);const r=t.eval;t.eval=e=>(t.match=null,r(e))})),L("else-if",((e,t)=>e.ifPart?.addCase(t))),L("else",((e,t)=>(t.eval=()=>!0,e.ifPart?.addCase(t),e.ifPart=null))),L("each",((e,t)=>{let r=t.eval;t.eval=e=>{let[s,a]=r(e),l=[];for(let r of a)l.push(new C(t.template,{...e,[s]:r},U));return l}}));export{O as default,L as directive,B as directives,W as patch,U as processor,E as registry,R as states};